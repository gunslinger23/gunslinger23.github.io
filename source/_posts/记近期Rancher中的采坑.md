---
title: è®°è¿‘æœŸRancherä¸­çš„é‡‡å‘
date: 2019-10-19 20:30:33
tags:
- Rancher
- Kubernetes
---

è¿‘æœŸç”±äºä¸šåŠ¡éœ€æ±‚ï¼Œéœ€è¦åœ¨Windowsç³»ç»Ÿä¸Šéƒ¨ç½²Rancherï¼Œç”±äºWindowsä¸­çš„Dockeræ¯”è¾ƒå¤šå‘ã€‚åœ¨è§£å†³äº†é—®é¢˜åé¡ºä¾¿è®°å½•ä¸€ä¸‹å¡«å……ä¸€ä¸‹åšå®¢ğŸ˜”

> ç³»ç»Ÿï¼šWindows Server 2018
> Docker: 18.09
> Kubernetes: 1.10
> Rancher: 2.2.8
> è§„æ¨¡ï¼šå•æœº

## Rancherè®¿é—®

ç”±äºæ˜¯å•æœºéƒ¨ç½²k8så’ŒRancherï¼Œä¸ºäº†é˜²æ­¢Rancherä¸é˜»ç¢Ingressçš„ç«¯å£è®¿é—®ï¼Œå°†443ç«¯å£æ˜ å°„åˆ°å…¶ä»–ç«¯å£ä¸Šã€‚

```shell
docker run -d --restart=unless-stopped \
-p <ä¸»æœºç«¯å£>:80 -p <ä¸»æœºç«¯å£>:443 \
-v <ä¸»æœºè·¯å¾„>:/var/lib/rancher/ \
-v /root/var/log/auditlog:/var/log/auditlog \
-e AUDIT_LEVEL=3 \
rancher/rancher:stable
```

åœ¨æˆ‘ä»¬éƒ¨ç½²å®ŒRancheråï¼Œå†ç”¨Ingressç»™Rancheråšä¸ƒå±‚è´Ÿè½½å‡è¡¡ã€‚

> æ³¨æ„ï¼š
>1.ç”±äºRancheræ˜¯ç‹¬ç«‹å®¹å™¨éƒ¨ç½²ï¼Œç«¯å£ç›´æ¥æš´éœ²åˆ°ç‰©ç†ä¸»æœºä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†åç«¯è®¾ç½®æˆ`ç‰©ç†ä¸»æœºçš„IP + HTTPç«¯å£`
> 2.ç”±äºåšäº†ä¸ƒå±‚ä»£ç†åSSLè¯ä¹¦ä¹Ÿæ˜¯ä½¿ç”¨äº†Cert-Manageræ¥ç®¡ç†ï¼ŒCAæ ¹è¯ä¹¦ä¹Ÿå°±ä¸éœ€è¦è®¾ç½®äº†ã€‚
> 3.Rancheræä¾›çš„é›†ç¾¤Kubeconfigæ–‡ä»¶åˆ æ‰CAè¯ä¹¦çš„å­—æ®µå³å¯æ­£å¸¸è®¿é—®ğŸ˜

## Rancherä¸­ Cert-Manager åº”ç”¨

Cert-Managerå°†ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬çš„é›†ç¾¤ä¸­ä½¿ç”¨çš„åŸŸåè¿›è¡Œç­¾è¯

åº”ç”¨å®‰è£…åä¼šé»˜è®¤è®¾ç½®ä¸€ä¸ªé›†ç¾¤ç­¾è¯è€…ï¼Œè¿™ä¸ªå·²ç»å¤Ÿæˆ‘ä»¬ä½¿ç”¨äº†ã€‚

æˆ‘ä»¬éœ€è¦åœ¨ç›¸å…³çš„è´Ÿè½½å‡è¡¡è¿›è¡Œè®¾ç½®

1. æ·»åŠ æ ‡ç­¾ `kubernetes.io/tls-acme: "true"` æ¥è§¦å‘Cert-Managerè¿›è¡Œè‡ªåŠ¨ç­¾è¯

2. Ingressçš„è®¾ç½®

```yaml
spec:
  tls:
  - hosts:
    - host.example.com
    secretName: host-example-crt
```

å¦‚æœæˆ‘ä»¬æœ‰å¤šä¸ªé›†ç¾¤ï¼Œéœ€è¦æ·»åŠ æ ‡ç­¾
`certmanager.k8s.io/cluster-issuer: é›†ç¾¤å(Rancherä¸­)`

## å…³äºRancherä¸­çš„PVC

åœ¨ä½¿ç”¨`hostpath`çš„å­˜å‚¨ç±»æ—¶ï¼Œç”±äºä½¿ç”¨çš„æ˜¯Windowsç³»ç»Ÿï¼Œæ–‡ä»¶å°†ä¼šç›´æ¥å­˜å‚¨åœ¨ç³»ç»Ÿä¸­ã€‚åœ¨ä½¿ç”¨æ—¶è¯·æ³¨æ„æƒé™é—®é¢˜ï¼Œå¦‚æœæ˜¯å¯¹äºæƒé™æœ‰ä¸¥æ ¼é™åˆ¶çš„ç¨‹åºå°†ä¼šå‡ºç°æŠ¥é”™ã€‚

> æƒé™é—®é¢˜æ˜¯ç‰¹å¤§å‘ï¼ğŸ¤®ä¸è¿‡å¬è¯´Windows
